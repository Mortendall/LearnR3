---
title: "Draft R Markdown document"
author: "Morten Dall"
output: html_document
---
##import raw data
```{r setup}
library(vroom)
library(here)
library(tidyverse)
library(fs)

options(dplyr.summarise.inform = FALSE)

```

```{r}
user_1_info_file <- here("data-raw/mmash/user_1/user_info.csv")
user_1_info_data <- vroom(
  user_1_info_file,
  col_select = -1,
  col_types = cols(
    Gender = col_character(),
    Weight = col_double(),
    Height = col_double(),
    Age = col_double()
  ),
  .name_repair = snakecase::to_snake_case)

user_1_info_data
                          
  ```
```

##Exercise: import of saliva data

```{r}
user_1_saliva_file <- here("data-raw/mmash/user_1/saliva.csv")
user_1_saliva_data_prep <- vroom(user_1_saliva_file,
                                 col_select = -1)

spec(user_1_saliva_data_prep)

user_1_saliva_data <- vroom(
    user_1_saliva_file,
    col_select = -1,
    col_types = cols(
  SAMPLES = col_character(),
  `Cortisol NORM` = col_double(),
  `Melatonin NORM` = col_double()),
    .name_repair = snakecase::to_snake_case
)

user_1_saliva_data
```





##Exercise: Import the Actigraph data
```{r}
import_actigraph_data(here("data-raw/mmash/user_1/actigraph.csv"))

```
##importing all the user_info files
```{r}
user_info_files <- dir_ls(here("data-raw/mmash/"),
                          regexp = "user_info.csv",
                          recurse = T)
user_info_list <- purrr::map_dfr(user_info_files, import_user_info, .id = "file_path_id")
View(user_info_list)
```

##Exercise Map the other datasets
```{r import data files}

user_data <- import_multiple_files("user_info.csv", import_user_info)
saliva_df <- import_multiple_files("saliva.csv", import_saliva_data)
actigraph_df <- import_multiple_files("Actigraph.csv", import_actigraph_data)
rr_df <- import_multiple_files("RR.csv", import_rr_data)

```

```{r}
user_data %>% 
    dplyr::mutate(user_id = stringr::str_extract(file_path_id, "user_[0-9][0-9]?")) %>% 
  select(-file_path_id)
View(user_data)
```
##remove file path and add user ID
```{r}

full_join(user_info, saliva_df, by = "user_id")
combined <- purrr::reduce(list(user_info, saliva_df), dplyr::full_join)
View(combined)

```

```{r}
user_info %>% 
  select(age)

saliva_df %>% 
  summarise(across(where(is.numeric), list(mean = mean, sd = sd)))

summarized_rr_df <- rr_df %>% 
  group_by(user_id, day) %>% 
  summarise(across(ibi_s, list(mean=mean, sd=sd), na.rm = T))
View(summarized_rr_df)
summarized_rr_df

reduce(list(user_info, saliva_df, summarized_rr_df), full_join)

saliva_with_day_df <- saliva_df %>% 
  mutate(day = case_when(
    samples == "before sleep" ~ 1,
    samples == "wake up" ~ 2,
    TRUE ~ NA_real_
  ))
saliva_with_day_df

reduce(list(user_info, saliva_with_day_df, summarized_rr_df), full_join)
```

##Exercise: Summarize and join the Actigraph data 
```{r}
actigraph_df_sum <- actigraph_df %>%
  select(-c(axis_1,axis_2,axis_3, inclinometer_off,inclinometer_standing, inclinometer_sitting, inclinometer_lying)) %>% 
  group_by(user_id, day) %>% 
  summarise(across(c(steps, hr, vector_magnitude), list(mean = mean, sd = sd), na.rm = T))
  

view(actigraph_df_sum)
combined_data <- reduce(list(user_info, saliva_with_day_df, summarized_rr_df, actigraph_df_sum), full_join)

View(combined_data)
```

